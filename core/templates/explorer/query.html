{% extends 'core/base.html' %}

{% load explorer_tags %}

{% block sql_explorer_navlinks %}
    {% if can_change %}
        <li{% if not query %} class="active" {% endif %}><a href="{% url 'query_create' %}">New Query</a></li>
        <li><a href="{% url 'explorer_playground' %}">Playground</a></li>
    {% endif %}
    {% if query %}<li class="active"><a href="">Query Detail</a></li>{% endif %}
        <li><a href="{% url 'explorer_logs' %}">Logs</a></li>
        <li><a href="{% url 'connection_browser_list' %}">Table browser</a></li>
{% endblock %}

{% block content %}
<div class="govuk-width-container">
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-full" id="query_area">
            <p class="govuk-heading-m govuk-!-margin-bottom-2">
                {% if query %}
                    {{ query.title }}
                    {% if shared %}
                        <small>&nbsp;&nbsp;shared</small>
                    {% endif %}
                    <a href="{% url 'explorer_logs' %}?query_id={{ query.id }}">History</a>
                {% else %}
                    New Query
                {% endif %}
            </p>
            <fieldset class="govuk-fieldset">
                {% if message %}

                    <div class="govuk-warning-text">
                        <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
                        <strong class="govuk-warning-text__text">
                            {{ message }}
                        </strong>
                    </div>
                {% endif %}

                {% if query %}
                    <form action="{% url 'query_detail' query.id %}" method="post" id="editor">{% csrf_token %}
                {% else %}
                    <form action="{% url 'query_create' %}" method="post" id="editor">{% csrf_token %}
                {% endif %}

                {% if error %}
                    <div class="govuk-error-summary" aria-labelledby="error-summary-title" role="alert" tabindex="-1" data-module="govuk-error-summary">
                        <h2 class="govuk-error-summary__title" id="error-summary-title">
                            {{ error|escape }}
                        </h2>
                        {% if form.non_field_errors %}
                            <div class="govuk-error-summary__body">
                                <ul class="govuk-list govuk-error-summary__list">
                                    {% for error in form.non_field_errors %}
                                        <li>
                                            {{ error }}
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}
                    </div>
                {% endif %}

                <div class="govuk-form-group{% if form.title.errors %} govuk-form-group--error {% endif %}">
                    <label class="govuk-label" for="id_title">
                        Title
                    </label>
                    {% if form.title.errors %}
                        {% for error in form.title.errors %}
                            <span id="title-error" class="govuk-error-message">
                                <span class="govuk-visually-hidden">Error:</span> {{ error|escape }}
                            </span>
                        {% endfor %}
                    {% endif %}
                    <input class="govuk-input govuk-input--width-30" id="id_title" name="title" type="text" {% if not can_change %}disabled{% endif %} value="{{ form.title.value|default_if_none:"" }}" />
                </div>

                <div class="govuk-form-group">
                    {% if form.connections|length > 1 and can_change %}
                        <label class="govuk-label" for="id_connection">
                            Connection
                        </label>
                        <select class="govuk-select" id="id_connection" name="connection">
                            {% for value, label in form.connections %}
                                <option value="{{ value }}"{% if form.connection.value == value %} selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    {% else %}
                        {# still need to submit the connection, just hide the UI element #}
                        <div class="hidden">
                        {{ form.connection }}
                        </div>
                    {% endif %}
                </div>

                <div class="govuk-form-group">
                    <label class="govuk-label" for="id_connection">
                        Description
                    </label>
                    <textarea class="govuk-textarea" id="id_description" name="description" cols="40" rows="2"  {% if not can_change %}disabled{% endif %}>{{ form.description.value|default_if_none:"" }}</textarea>
                </div>
                <input type="hidden" id="id_created_by_user" name="created_by_user" value="{{ form.created_by_user_email }}" />
                <div class="govuk-form-group {% if form.sql.errors %} govuk-form-group--error {% endif %}">
                    <label class="govuk-label" for="playground-sql">
                        Playground SQL
                    </label>
                    {% if form.sql.errors %}
                        {% for error in form.sql.errors %}
                            <span id="sql-error" class="govuk-error-message">
                                <span class="govuk-visually-hidden">Error:</span> {{ error|escape }}
                            </span>
                        {% endfor %}
                    {% endif %}
                    <div class="govuk-textarea" id="gov-uk-sql-wrapper" rows="10">
                        <div id="ace-sql-editor">{{ query.sql }}</div>
                    </div>
                    <textarea style="display: none;" name="sql">{{ query.sql }}</textarea>
                </div>

                <div class="govuk-form-group">
                    {% if can_change %}
                        <button class="govuk-button" data-module="govuk-button" id="save_button">
                            Save & Run
                        </button>
                        <button class="govuk-button" data-module="govuk-button" id="save_only">
                            Save only
                        </button>
                    {% else %}
                        <button class="govuk-button" data-module="govuk-button">
                            Refresh
                        </button>
                    {% endif %}
                    <button class="govuk-button" data-module="govuk-button" id="download_csv">
                        Download CSV
                    </button>
                    <button class="govuk-button" data-module="govuk-button" id="download_excel">
                        Download Excel
                    </button>

                    <button class="govuk-button" data-module="govuk-button" id="download_json">
                        Download JSON
                    </button>

                    <button
                        class="govuk-button"
                        data-module="govuk-button"
                        id="show_schema_button"
                        type="button">
                        Show Schema
                    </button>

                    <button class="govuk-button" data-module="govuk-button" type="button">
                        Format
                    </button>

                </div>
                </form>
            </fieldset>
        </div>

        <div id="schema" style="display: none;">
            <iframe src="about:blank" height="828px" frameBorder="0" id="schema_frame"></iframe>
        </div>
    </div>
</div>

{% include 'explorer/preview_pane.html' %}

{% endblock content %}